---
title: "Study Areas SUMHAL"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: yeti
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library('flexdashboard')
library('rgdal')
library("leaflet") 
library("sf")
library("tidyverse")
library("raster")
library("sp")
library("lubridate")
```

```{r}
# Area of Interest 
aoi_sni <- st_read("data/aoi/aoi_sni.shp", quiet = TRUE) 
aoi_sni <- st_transform(aoi_sni, crs = 4326)

# Montes 
montes <- st_read("data/geo_pesadas/MonteCatalogo.shp", quiet = TRUE)
montes <- st_transform(montes, crs = 4326)
# convert url to html anchor tag 

# Incendios 
fires <- st_read("data/geo_pesadas/incendios_historico.shp", quiet = TRUE)
fires <- st_transform(fires, crs=4326)
```

```{r optionsMap}
popup_montes <- paste0(
  "<strong>Nombre:</strong> ", montes$NOMBRE,
  "<br><strong>Código:</strong> ", montes$CODIGO_JA,
  "<br><strong>Superficie (ha.):</strong> ", round(as.numeric(montes$SUP_HA), 2),
  paste0("<br><a href=", montes$ACCESO_INF, ' target="_blank"><strong>Mas info</strong></a>')
)

popup_fires <- paste0(
  "<strong>Campaña:</strong> ", fires$CAMPANA,
  "<br><strong>Fecha:</strong> ", lubridate::ymd(fires$FECHA_Inic),
  "<br><strong>Superficie (ha.):</strong> ", round(as.numeric(fires$SHAPE_Area), 2)
)
```


```{r baseMap}
map_base <- leaflet() %>%
  addWMSTiles("http://www.ideandalucia.es/wms/mdt_2005?",
    layers = "Sombreado_10",
    options = WMSTileOptions(format = "image/png", transparent = TRUE),
    attribution = '<a href="http://www.juntadeandalucia.es/institutodeestadisticaycartografia" target="_blank">Instituto de Estadística y Cartografía de Andalucía</a>',
    group = "Hillshade"
  ) %>%
  addTiles(
    urlTemplate = "http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
    attribution = '<a href="https://carto.com/attributions">CARTO</a>',
    group = "Basemap"
  ) %>%
  addWMSTiles("http://www.ideandalucia.es/services/toporaster10/wms?",
    layers = "toporaster10",
    options = WMSTileOptions(format = "image/png", transparent = FALSE),
    attribution = '<a href="http://www.juntadeandalucia.es/institutodeestadisticaycartografia" target="_blank">Instituto de Estadística y Cartografía de Andalucía</a>',
    group = "Topographical"
  ) %>%
  addWMSTiles("http://www.ideandalucia.es/wms/mta10r_2001-2013?",
    layers = "mta10r_2001-2013",
    options = WMSTileOptions(format = "image/png", transparent = FALSE),
    attribution = '<a href="http://www.juntadeandalucia.es/institutodeestadisticaycartografia" target="_blank">Instituto de Estadística y Cartografía de Andalucía</a>',
    group = "topo2013"
  ) %>%
  addProviderTiles("Esri.WorldImagery", group = "Satellite") %>% # Layers control
  addLayersControl(
    position = "bottomright",
    baseGroups = c("Satellite", "Basemap", "Hillshade", "Topographical", "topo2013"),
    overlayGroups = c("Montes Públicos", "Incendios", "Vegetation"),
    options = layersControlOptions(collapsed = TRUE)
  )

```


```{r EnrichMap}
map_base_enriquecido <- 
  map_base %>% 
  addPolygons(
    data = montes,
    group = "Montes Públicos",
    fillColor = "red", fillOpacity = 0.4,
    stroke = TRUE, color= "red", weight = 1,
    popup = popup_montes,
    label = ~CODIGO_JA,
    labelOptions = labelOptions(
      noHide = FALSE,
      offset = c(0, 0),
      textOnly = F,
      style = list("color" = "black")
    )
  ) %>% 
  addPolygons(
    data = fires,
    group = "Incendios",
    fillColor = "orange", fillOpacity = 0.4,
    stroke = TRUE, color= "orange", weight = 1,
    popup = popup_fires,
    label = ~CAMPANA,
    labelOptions = labelOptions(
      noHide = FALSE,
      offset = c(0, 0),
      textOnly = F,
      style = list("color" = "black")
    )
  )

```



Sierra de las Nieves (SNI)
=============================================================================

```{r}
# Read custom layers 
veg_sni <- st_read("data/geo_pesadas/veg10/veg10_sni.shp", 
                   options = "ENCODING=UTF-8")

veg <- st_transform(veg_sni, crs = 4326) %>% 
  dplyr::select(COM1, D_COM1, D_COM1_COB, D_CO1_ETAP,
                COM2, D_COM2, D_COM2_COB, D_CO2_ETAP,
                COM3, D_COM3, D_COM3_COB, D_CO3_ETAP,
                D_USO)


urlRediam <- "https://laboratoriorediam.cica.es/recursosVisor/pdfs/aplicacionVegetacion/COMU/"

tb <- ' target="_blank">'

popup_veg <- paste0(
  "<strong>Uso del Suelo:</strong> ", veg$D_USO,
  "<br><strong>Comunidad Predominante 1:</strong> ", paste0("<br><em>", veg$D_COM1, "</em>"),
  "<br>COD: ", paste0(
    "<a href=",
    paste0(urlRediam, veg$COM1, ".pdf"),
    tb,
    paste0(veg$COM1, "</a>")
  ),
  "<br>Cobertura: ", veg$D_COM1_COB,
  "<br>Etapa sucecional:",
  paste0("<br>", veg$D_CO1_ETAP),
  # Comunidad pred. 2
  "<br><strong>Comunidad Predominante 2:</strong> ",
  ifelse(veg$D_COM2 == "-", "",
    paste0("<br><em>", veg$D_COM2, "</em>")
  ),
  "<br>COD: ", ifelse(veg$COM2 == -1, "",
    paste0(
      "<a href=",
      paste0(urlRediam, veg$COM2, ".pdf"),
      tb,
      paste0(veg$COM3, "</a>")
    )
  ),
  "<br>Cobertura: ", ifelse(veg$D_COM2_COB == "Ausente", "", veg$D_COM2_COB),
  # Comunidad pred. 3
  "<br><strong>Comunidad Predominante 3:</strong> ",
  ifelse(veg$D_COM3 == "-", "",
    paste0("<br><em>", veg$D_COM3, "</em>")
  ),
  "<br>COD: ",
  ifelse(veg$COM3 == -1, "",
    paste0(
      "<a href=",
      paste0(urlRediam, veg$COM3, ".pdf"),
      tb,
      paste0(veg$COM3, "</a>")
    )
  ),
  "<br>Cobertura: ", ifelse(veg$D_COM3_COB == "Ausente", "", veg$D_COM3_COB)
)

```


```{r}
# Set spatial extension 
myext <- st_bbox(aoi_sni) %>% as.vector()

map_base_enriquecido %>%
  fitBounds(myext[1], myext[2], myext[3], myext[4]) %>% 
  addPolygons(
    data = veg,
    group = "Vegetation",
    fillColor = "green", fillOpacity = 0.4,
    stroke = TRUE, color= "green", weight = 1,
    popup = popup_veg,
    label = ~D_COM1,
    labelOptions = labelOptions(
      noHide = FALSE,
      offset = c(0, 0),
      textOnly = F,
      style = list("color" = "black")
    )
  )


# 
```



Info
=============================================================================

dkkkkkkkk



